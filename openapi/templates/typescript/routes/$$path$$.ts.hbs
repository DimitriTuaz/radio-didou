/** Loopback 4 - OpenApi Route: {{operation_name}} **/

import request from 'superagent';
import { OpenAPI } from '..';
import * as schema from '../schemas';

{{#each operation as | operation |}}
    {{#each operation.path as | path pathName|}}
        {{#if path.x-operation-name}}
            {{#if @../first}}
export namespace {{{path.x-controller-name}}} {
            {{/if}}
        {{#each path.responses as | response |}}
            {{#if @first}}

    export function {{{path.x-operation-name}}}({{~>params path=path~}}): Promise<{{~>contentType response=response~}}> {
        return new Promise<{{~>contentType response=response~}}>(async (resolve, reject) => {
            try {
                const response = await request
                    .{{@../key}}(OpenAPI.URL + {{{requestPath operation.path_name}}})
                {{#if path.requestBody}}
                    {{>post path=path}}
                {{/if}}
                {{#each path.parameters as | parameter |}}
                    {{>query parameter=parameter}}
                {{/each}}
                    {{>acceptHeader response=response}}
                    {{>withCredentials path=path}}
                if (response.status !== {{@key}}) {
                    reject(response);
                }
                resolve(response.body);
            } catch (error) {
                reject(error);
            }
        });
    }
            {{/if}}
        {{/each}}
        {{/if}}
    {{/each}}
{{/each}}
}
